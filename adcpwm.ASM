LIST P=16F877, F=INHX8M
INCLUDE<P16F877.INC>
INCLUDE<P16BITS.INC>

__CONFIG 3FF9H

NUMH 	EQU 21H
NUML	EQU 20H
TEMP	EQU 22H
COUNTER	EQU 23H
VAR 	EQU 24H
CONST 	EQU 25H

VAR1 	EQU 26H
VAR2 	EQU 27H

VAR16	EQU 30H

TEST1	EQU 28H
TEST2	EQU 29H

COUNT 	EQU 30H
RANGE1	EQU 31H
RANGE2	EQU 32H
RANGE3	EQU 33H

ORG 0H 
GOTO WEEE
ORG 4
GOTO INT_ROUTINE

WEEE	
		MOVLW B'10000001'	
		MOVWF ADCON0
		BANKSEL ADCON1
	
		MOVLW B'10000101'
		MOVWF ADCON1
		BANKSEL ADCON0
	
		BANKSEL TRISA
		MOVLW 0FFH
		MOVWF TRISA
		CLRF TRISC
		CLRF TRISB
		CLRF TRISD
	
	
		MOVLW 04H
		MOVWF OPTION_REG
		
	
		BANKSEL PORTA
		INIT16 VAR1, 0000H
		INIT16 RANGE1, 352H ;850
		INIT16 RANGE2, 1F4H ;500
		INIT16 RANGE3, 0C8H ;200

	;	BANKSEL PR2
	;	MOVLW 0F9H			;B'11111001'
	;	MOVWF PR2
	;	BANKSEL T2CON
	;	MOVLW 05H			;B'00000101'
	;	MOVWF T2CON
	;	MOVLW 3CH			;B'00111100'
	;	MOVWF CCP1CON
MAIN	
		
		CALL READ_ADC
		BANKSEL VAR1
	
		CMP16 VAR1, RANGE3
		BTFSC STATUS, C
		GOTO PWM3
		GOTO PWM2
	;	CMP16 VAR1, RANGE2
	;	BTFSC STATUS, C
	;	GOTO PWM2
	;	CMP16 VAR1, RANGE1
	;	BTFSC STATUS, C
	;	GOTO PWM1
	;	GOTO PWMWALA
		GOTO MAIN
		

PWM1
		BANKSEL PR2
		MOVLW 0CFH			;B'11001111'
		MOVWF PR2
		BANKSEL T2CON
		MOVLW 07H			;B'00000111'
		MOVWF T2CON
		MOVLW 67H			;B'01100111'
		MOVWF CCPR1L
		MOVLW 3CH			;B'00111100'
		MOVWF CCP1CON	
	
		MOVLW 01H
		MOVWF PORTD

		GOTO MAIN

PWM2
		BANKSEL PR2
		MOVLW 58H			;B'01011000'
		MOVWF PR2
		BANKSEL T2CON
		MOVLW 07H			;B'00000111'
		MOVWF T2CON
		MOVLW 3EH			;B'00111110'
		MOVWF CCPR1L
		MOVLW 1CH			;B'00011100'
		MOVWF CCP1CON
		
	
		MOVLW 02H
		MOVWF PORTD
	
		GOTO MAIN

PWM3
		BANKSEL PR2
		MOVLW 0F9H			;B'11111001'
		MOVWF PR2
		BANKSEL T2CON
		MOVLW 05H			;B'00000101'
		MOVWF T2CON
		MOVLW 0FCH			;B'11111100'
		MOVWF CCPR1L
		MOVLW 3CH			;B'00111100'
		MOVWF CCP1CON

	
		MOVLW 04H
		MOVWF PORTD
	
		GOTO MAIN
PWMWALA
		
		BANKSEL CCPR1L
		MOVLW B'00000000'
		MOVWF CCPR1L
		MOVWF CCPR1H
		MOVWF CCP1CON

		MOVLW 0FFH
		MOVWF PORTD
		GOTO MAIN
		

READ_ADC

		BSF ADCON0, GO_DONE
		BTFSC ADCON0, GO_DONE
		GOTO $-1
		MOVF ADRESH, W
		ANDLW 03H
		MOVWF NUMH
		BANKSEL ADRESL
		MOVF ADRESL, W
	
		BANKSEL ADRESH
		MOVWF NUML



		BANKSEL ADRESH
		MOVF NUMH, W
		MOVWF VAR1

		MOVLW D'8'
		MOVWF COUNTER
SHIFT	LSL16 VAR1
		DECFSZ COUNTER
		GOTO SHIFT
		RLF VAR1
	
		MOVF NUML, W
		MOVWF VAR1


		RETURN
	
DELAY: MOVWF COUNT
	   MOVLW 00H
	   XORWF COUNT, W
	   BTFSS STATUS, Z
	   GOTO $-3
	   RETURN

INT_ROUTINE
	BCF INTCON, T0IF
	DECF COUNT, F

	RETFIE


END